/*
    This is a port of the "driver" generated by recSQL for even in the recSQL 
    distribution.
    This is hand-coded rather than generated.
*/


package forflix.march;

import java.sql.*;


public class Even {

    private static int getRowCount(Statement stmt, String tableName) throws Exception {
        String query = "SELECT count(1) FROM " + tableName + ";";
        ResultSet rs = stmt.executeQuery(query);
        rs.next();
        return rs.getInt(1);
    }


    private static void setupDb(Connection conn) throws Exception {
        Statement stmt = conn.createStatement();
        stmt.execute("DROP TABLE IF EXISTS even");
        stmt.execute("CREATE TABLE even (x REAL)");
        stmt.execute("DROP TABLE IF EXISTS odd");
        stmt.execute("CREATE TABLE odd (x REAL)");
        stmt.close();
        conn.commit();
    }

    private static void stratum1(Connection conn) throws Exception {
        int size1, size2 = 0;
        Statement stmt = conn.createStatement();
        stmt.execute("INSERT INTO even (x) VALUES (0);");
        size1 = getRowCount(stmt, "even");
        size1 = size1 + getRowCount(stmt, "odd");

        String insert2 = "INSERT INTO even SELECT odd.x+1 FROM odd WHERE odd.x < 100 EXCEPT SELECT * FROM even;";
        String insert3 = "INSERT INTO odd SELECT even.x+1 FROM even WHERE even.x < 100 EXCEPT SELECT * FROM odd;";
        Boolean test = true;
        while (test) {            
            size2 = 0;
            stmt.execute(insert2);
            size2 = size2 + getRowCount(stmt, "even");
            stmt.execute(insert3);
            size2 = size2 + getRowCount(stmt, "odd");
            if (size2 > size1) {
                size1 = size2;
            }
            else {
                test = false;
            }
        }
        System.out.println("end: " + size2);
        stmt.close();
        conn.commit();
    }


    
    public static void main(String[] args) throws Exception {        
        Connection conn = DriverManager.getConnection("jdbc:sqlite:e://coding/java/netbeans-for-flix/data/even.sqlite");
        conn.setAutoCommit(false);
        System.out.println("Setup...");
        setupDb(conn);
        System.out.println("Stratum 1...");
        stratum1(conn);
        conn.close();
    }
}
